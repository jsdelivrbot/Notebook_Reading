# 数据库技术

## 一 绪论

### 概念

- 数据
- 信息=数据+数据处理

### 数据库技术历史

人工管理阶段|1950s中期前；

文件系统阶段|1950-60s,mid；进步点：长期保存；相应管理软件；程序与数据独立

数据库系统阶段|1960s,end-；进步点：数据冗余度；数据独立性；数据一致性

### 数据库系统

#### 组成

- 数据库
  - 长期存储|有组织（集成性）|可共享 的数据集合。
- 用户
  - 终端用户
  - 应用程序员
  - 数据库管理员
    - 数据库设计
    - 安全性与完整性定义；权限管理
    - 恢复数据库
- DBMS（软件）
- 硬件

#### 内部体系结构

- 概念模式 Schema:全体数据逻辑结构的抽象表示
- 外模式/子模式：个别用户使用的数据结构和特征（不唯一）
- 内模式：全体数据物理存储结构的描述，但不关心物理位置

二级映像：逻辑和物理独立性

### 数据库管理系统

#### 主要功能

- 数据定义 DDL
- 数据操纵 DManipulationL
- 运行管理
  - 安全性控制
  - 完整性控制
  - 并发控制
  - 数据恢复
- 数据组织存储和管理
  - 数据字典
  - 用户数据
- 建立和维护
- 数据通信
  - 与其它软件系统之间

### 数据模型

- 数据结构
  - 层次 网状 关系
- 数据操作
- 约束条件

#### 信息世界的概念

- 实体 Entity
- 属性 Attribute [椭圆]
  - 分量：某个取值
- 实体型 Entity type： [矩形框]
  - 学生（学号、姓名、性别）
- 实体集 Entity Set
- 键 码 Key：唯一标识一个实体的属性集合
- 域 Domain：属性值的取值范围
- 联系：实体型之间 [菱形]
  - 1:1 班级和班长
  - 1:n 班级和学生
  - m:n 教师和学生

计算机|信息界|关系型
--|--|--
字段|属性|属性
实体|记录|元组
实体集|文件|关系

#### 数据模型分类

模型|名称|数据联系|缺点
--|--|--|--
层次|Hierarchical|树结构|难表示多队多联系
网状|network|图结构|完整性约束弱；独立性差
关系|relational|二维表|存取路径不可见

## 二 关系数据库

### 关系理论

- 基数：域包含的值的个数，用m表示
- 笛卡尔积：n个域之间运算，结果是（元素）n元组的集合
- 关系 $D1\times D2$的任一（实际中只选取有意义的）子集称为定义在D1,D2上的2元关系
  - R(D1,D2)  n=2
  - 关系的目或度 n
  - 关系的基数 r 关系内元组个数
  - 关系头：属性名的集合
  - 关系提：数据内容
- 关系性质
  - 元组不重复
  - 顺序不相干（元组或属性）
  - 同属性的各个属性值，域相同
  - 各个属性，名字相异
  - 每个分量是不可分的数据项：属性原子性
    - 规范化关系的基准

### 关系的码

- 候选码 Candidate key： 属性集
  - 唯一性
  - 最小性
- 主关系键|主码|关键字：选自候选码
  - 主属性：包含在主码内
  - 非主属性：不包含于任何候选码
  - 全码 all-key：所有属性的组合是候选码
- 参照关系 referencing relation
  - R2参照R1:R2的属性C，不是R2主码，是R1主码
  - X为R1的外部关系键|外码

### 关系模型完整性

- 实体完整性 Entity Integrity:主码值均不为空
- 参照完整性 Referential：外码取参照的主码中的值或者控制
- 用户定义完整性：语义要求

### 关系数据库模式

- 关系模式 relation schema: R(U,D,Dom,F)
  - 关系名
  - D 属性集合
  - Dom 属性向域的映像集合
  - 属性间依赖关系
- 关系数据库
  - 型：模式
  - 值：内容

### 关系代数

- 集合运算
  - 并； 差； 笛卡尔积
- 关系概念
  - $t[A_i]$ 元组t相应于属性A_i的一个分量
  - 连接
  - 象集
- 关系运算
  - 选择：按条件选择元组
  - 投影：选择属性列组成新关系
  - 连接：在笛卡尔积上选取满足条件的子集
  - 除法：R(X,Y)÷S(W,Z)
    - W与Y域相同
    - 选取X的某些值x，x对应的各元组中的y集合包含W的全部y值

## 三 SQL

### 数据类型

- NUMERIC(P,[S]) 精度P（总位数） 小数位数S
- CHAR(N) 长度N

### 建表语句和相关约束

```sql
CREATE TABLE S
(SNO CHAR(6) ,
SN VARCHAR(10) UNIQUE,--只允许一个空值
AGE INT CONSTRAINT CONS1 NOT NULL,
SEX CHAR(2) DEFAULT '男', --DEFAULT 默认值
DEPT VARCHAR(20),
PRIMARY KEY(SNO,DEPT));
```

约束名称省略时，系统会自动生成一个。

```sql
CREATE TABLE R
(SNO CHAR(6) CONSTRAINT CONS2 NOT NULL PRIMARY KEY,
SNA CHAR(10) FOREIGN KEY REFERENCES S(SN),
AGE NUMERIC(2,0) CHECK(SCORE>0));--CHECK既能作表约束也可作列约束
```

`从表`：包含外码；`主表`：包含从表所引用的主码。

### 修改删除基本表

ADD方式：增加新列（自动填充NULL值）或完整性约束

```SQL
ALTER TABLE S
ADD (CLASS_NO CHAR(6),
     ADDR CHAR(40));--NOT NULL不可用
```

```sql
ALTER TABLE SC
ADD CONSTRAINT SCORE_CHK
CHECK (SCORE BETWEEN 0 AND 100);
```

ALTER方式：修改某些列

```SQL
ALTER TABLE S
ALTER COLUMN--不能修改列名或减少数据宽度
(SNO CHAR(8) not null);--只能改NULL约束
```

DROP方式：删除完整性约束

```SQL
ALTER TABLE S DROP CONSTRAINT AGE_CHK;
```

删除表：索引随之删除，视图会保留但不可用。

```SQL
DROP TABLE S;
```

### 索引

### 查询

### 数据更新

#### 插入

省略列名（此时新纪录必须在每个属性上均有值）

```SQL
INSERT INTO S VALUES(‘s7’,‘郑冬’,‘女’,21,‘计算机’)
```

指定列名（部分列）

```SQL
INSERT INTO SC (SNO,CNO)
VALUES ('s7', 'c1');
```

插入多行（利用子查询的表间复制）

```SQL
INSERT INTO AVGSAL
SELECT DEPT,AVG(SAL) FROM T
GROUP BY DEPT ;
```

#### 修改

```sql
UPDATE <表名>
SET <列名>=<表达式> [,<列名>=<表达式>]
[WHERE <条件>]
```

表达式可以是常量，基于属性的运算，或子查询的结果。

####　删除

```SQL
DELETE FROM TC  --注意：两个关键字连用
WHERE TNO=(SELECT TNO
FROM T  WHERE TN=‘刘伟’);
```

### 视图

- 记录来自基本表，只有定义被存储。
- 用户可在视图上再定义视图或进行查删改操作
- 作用：
  - 数据保密，限制访问
  - 简化复杂的查询操作
  - 保证外模式与模式的逻辑独立性

#### 定义和删除视图

```SQL
CREATE VIEW <视图名>[(<视图列表>)] AS <子查询>
```

- 视图列表是视图当中的列名，可由子查询中的AS子句给定
- 子查询中ORDER BY子句和 DISTINCT短语禁用

```SQL
DROP VIEW SUB_T;  --删除
```

删除视图后，其导出视图不会删除，但它们已无意义。

#### 视图消解

- View Resolution
- 对视图执行查询时，系统会将数据字典中的视图定义和用户查询结合。

### 数据控制 Data Control Language

#### 权限与角色

概念|授予主体|权限范围
--|--|--
系统权限|数据库管理员|比如，建表
对象权限|基本表或视图创建者|对数据库对象的操作

角色：多种权限的集合；授给用户或其他角色

##### 系统权限授予

```SQL
GRANT <权限>|<角色> [,<权限>|<角色>] -- 如"CREATE TABLE"
TO <用户名>|<角色>|PUBLIC[,<用户名>|<角色>] --public代表全体用户
[WITH ADMIN OPTION] --允许转授
```

##### 对象权限授予

```SQL
GRANT ALL|<权限>[(列名[,列名])][,<权限>]
ON <对象名> -- 基本表或视图
TO <用户名>|<角色>|PUBLIC[,<用户名>|<角色>]
[WITH GRANT OPTION]
```

只有SELECT INSERT UPDATE才需要指定列名

##### 对象权限收回

```SQL
REVOKE SELECT ON C FROM USER1
```

## 四 关系数据库规范化理论

### 第一范式 1NF

每一个分量是不可分的数据项

#### 存在问题

- 数据冗余
- 更新异常 Update Anomalies
- 插入异常 Insertion
- 删除异常

### 数据依赖

关系内部，属性与属性之间的依赖关系

- 多值依赖
- 函数依赖 X→Y
  - X函数确定Y Y函数依赖于X
  - 平凡与非平凡
  - 完全与部分：Y是否依赖于X的真子集
  - 传递与直接

主属性Prime Attribute：包含在任何一个候选码中的属性。

外部码Foreign Key：是另一个关系模式的码。

### 第二范式

非主属性完全依赖于码

投影分解，不完全依赖的属性，新的关系。

### BC范式

1. 所有非主属性对每一个码都是完全函数依赖
1. 所有主属性，对不包含它的码，完全函数依赖
1. 没有属性完全函数依赖于非码属性组

范式|要点
--|--
2NF|非主属性完全依赖于码
3NF|不存在传递依赖
BCNF|决定属性组都包含码

## 五 数据库安全保护

### 数据库恢复

#### 登记日志 logging

- 内容
  - 事务ID
  - 操作类型
  - 操作对象
  - 新值旧值
  - 关键时刻（事务起止回写时间点）
- 原则（避免事务处理半途故障导致不可恢复）
  - 登记按照并行事务执行次序
  - 先写日志，后写数据库

#### 数据转储 data dump

定期将整个数据库复制到多个存储设备

- 海量 与 增量转储（只转储更新过的数据）
- 静态（期间不允许数据存取活动） 与 动态转储（配合日志文件）

### 数据库故障

#### 事务故障

- 非预期、不正常的程序结束造成

#### 系统故障

- 所有运行中事务均非正常结束
- 原因：硬件错误/OS错误

#### 介质故障 Media Failure

辅助存储器介质遭到破坏